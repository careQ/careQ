<html layout:decorate="~{layout/layout.html}" xmlns:layout="http://www.w3.org/1999/xhtml">
<head>
    <title>예약 신청 페이지</title>
    <!--jQuery-->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <link href="/webjars/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <script src="/webjars/jquery/jquery.min.js"></script>
    <script src="/webjars/sockjs-client/sockjs.min.js"></script>
    <script src="/webjars/stomp-websocket/stomp.min.js"></script>
    <script>
        var stompClient = null;

        function connect() {
            var socket = new SockJS('/ws/reservation');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);
                stompClient.subscribe('/topic/reservations/main/subjects/'+window.location.pathname.split('/')[3]
                    +'/hospitals/'+window.location.pathname.split('/')[5], function (message) {
                    console.log(JSON.parse(message.body));
                });
            });
        }

        function send(memberId) {
            let msg = {
                'userType': 'MEMBER',
                'memberId': memberId,
                'hospitalId': window.location.pathname.split('/')[5],
                'subjectId': window.location.pathname.split('/')[3],
                'status': 'PENDING'
            }

            stompClient.send("/app/reservation/main", {}, JSON.stringify(msg));
        }

        $(function () {
            var memberId = document.getElementById('getMemberId').value;
            $(document).ready(function(){connect();})
            $( "#btn-reservation" ).click(function() {
                send(memberId); });
        });
    </script>
</head>
<body>
<main layout:fragment="main" style="height: 100vh; display: flex; justify-content: center; align-items: center;">
    <div class="sm:w-1/3 md:w-1/2 lg:w-1/3 h-2/3 flex flex-col items-center justify-center overflow-hidden">
        <!-- TODO: API 수정 -> 헤더 -->
        <!-- 헤더 -->
        <div class="h-8 w-64 relative">
            <a class="absolute left-2" th:href="@{/members/subjects/{subjectId}/hospitals/{hospitalId}(subjectId=${subject.id}, hospitalId=${hospital.id})}">
                <button>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="#78C4BA">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                </button>
            </a>
        </div>
        <!-- 아이콘 -->
        <div class="flex w-64 justify-center mt-5">
            <div class="mb-6 inline-block rounded-full bg-[#C0E1DE] p-4">
                <div class="inline-block rounded-full bg-[#78C4BA] p-4">
                    <svg class="w-6 h-6 fill-[#ffffff]" viewBox="0 0 576 512" xmlns="http://www.w3.org/2000/svg">
                        <path d="M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z"></path>
                    </svg>
                </div>
            </div>
        </div>
        <!-- 회원 기본 정보 -->
        <div class="w-64 mb-7 flex flex-col text-center">
            <input id="getMemberId" type="hidden" th:value="${@rq.getMember().getId()}">
            <p class="font-semibold text-l" th:text="${@rq.getMember.username + '님이 선택하신'}"></p>
            <p><span class="text-[#78C4BA] text-l" th:text="|${hospital.name} ${subject.name}|">병원 / 진료과</span></p>
        </div>
        <!-- 예약 현황 카테고리 -->
        <div class="flex justify-between w-64 mb-10">
            <div class="w-1/3 rounded bg-[#78C4BA] text-center p-1 border border-[#78C4BA] mr-4">
                <div class="text-[#ffffff] text-sm">예약 신청</div>
            </div>
            <div class="w-1/3 rounded bg-[#FFFFFF] text-center p-1 border border-[#78C4BA]">
                <div class="text-[#78C4BA] text-sm">예약 대기</div>
            </div>
            <div class="w-1/3 rounded bg-[#FFFFFF] text-center p-1 border border-[#78C4BA] ml-4">
                <div class="text-[#78C4BA] text-sm">예약 확정</div>
            </div>
        </div>
        <!-- 달력 -->
        <div class="flex-col mb-10">
            <label for="startDateInput" class="sr-only">예약 날짜 선택</label>
            <input type="date" name="startDate" class="text-gray-300 select select mb-0.5 custom-input" id="startDateInput" style="width: 260px;" />
        </div>
        <!-- 예약 시간 선택 -->
        <div class="flex justify-between w-64 mb-3">
            <button class="w-1/3 rounded text-center p-1 border border-[#78C4BA] mr-4"
                    onclick="selectTime('09:00', this)">09:00</button>
            <button class="w-1/3 rounded text-center p-1 border border-[#78C4BA]"
                    onclick="selectTime('10:00', this)">10:00</button>
            <button class="w-1/3 rounded text-center p-1 border border-[#78C4BA] ml-4"
                    onclick="selectTime('11:00', this)">11:00</button>
        </div>
        <div class="flex justify-between w-64 mb-3">
            <button class="w-1/3 rounded text-center p-1 border border-[#78C4BA] mr-4"
                    onclick="selectTime('13:00', this)">13:00</button>
            <button class="w-1/3 rounded text-center p-1 border border-[#78C4BA]"
                    onclick="selectTime('14:00', this)">14:00</button>
            <button class="w-1/3 rounded text-center p-1 border border-[#78C4BA] ml-4"
                    onclick="selectTime('15:00', this)">15:00</button>
        </div>
        <div class="flex justify-between w-64 mb-3">
            <button class="w-1/3 rounded text-center p-1 border border-[#78C4BA] mr-4"
                    onclick="selectTime('16:00', this)">16:00</button>
            <button class="w-1/3 rounded text-center p-1 border border-[#78C4BA]"
                    onclick="selectTime('17:00', this)">17:00</button>
            <button class="w-1/3 rounded ml-4" style="background-color: rgba(255, 255, 255, 0.5);">
                <!-- 비어 있는 시간 슬롯 -->
            </button>
        </div>
        <!-- 예약하기 버튼 -->
        <button type="submit" id="btn-reservation" class="btn btn-md btn-accent gap-3 border-none w-64" style="background-color: #78C4BA; padding: 5px 15px; margin: 10px; border: 1px solid #78C4BA; box-shadow: none;">
            <span class="text-white" style="font-size: 15px;">예약하기</span>
        </button>
        <form id="reservation-form" th:action="@{/members/subjects/{subjectId}/hospitals/{hospitalId}/reservations(subjectId=${subject.id}, hospitalId=${hospital.id})}" method="POST">
            <input type="hidden" th:name="_csrf" th:value="${_csrf.token}"/>
            <input type="hidden" name="selectedDate" id="selectedDate">
            <input type="hidden" name="selectedTime" id="selectedTime">
        </form>
        <script>
            var selectedTime = null; // 선택한 시간을 저장할 변수

            function selectTime(time, button) {
                var selectedDate = document.getElementById("startDateInput").value;

                // 날짜를 선택하지 않은 경우 경고 표시
                if (!selectedDate) {
                    alert("날짜를 선택하세요.");
                } else {
                    selectedTime = time;
                    console.log("선택한 날짜:", selectedDate);
                    console.log("선택한 시간:", selectedTime);

                    // 모든 버튼의 배경색을 초기화, 예약하기 버튼은 제외
                    var buttons = document.querySelectorAll("button:not(#btn-reservation)");
                    buttons.forEach(function (btn) {
                        btn.style.backgroundColor = "#FFFFFF";
                    });

                    // 선택한 버튼의 배경색 변경
                    button.style.backgroundColor = "#78C4BA";

                    // 선택한 날짜와 시간을 숨김 필드에 설정
                    document.getElementById("selectedDate").value = selectedDate;
                    document.getElementById("selectedTime").value = selectedTime;
                }
            }

            // 예약하기 버튼 클릭 시 예약을 처리하는 함수
            document.getElementById("btn-reservation").addEventListener("click", function () {
                var selectedDate = document.getElementById("startDateInput").value;

                // 날짜와 시간이 선택되지 않은 경우 경고 표시
                if (!selectedDate || !selectedTime) {
                    alert("날짜와 시간을 선택하세요.");
                } else {
                    // 폼을 제출
                    document.getElementById("reservation-form").submit();
                }
            });

        </script>
        <!--        <script>-->
        <!--            // 오늘 날짜 구하기-->
        <!--            var today = new Date();-->
        <!--            today.setDate(today.getDate() + 1);-->

        <!--            // 날짜를 yyyy-MM-dd 형식으로 변환-->
        <!--            var yyyy = today.getFullYear();-->
        <!--            var mm = today.getMonth() + 1;-->
        <!--            var dd = today.getDate();-->

        <!--            if (mm < 10) {-->
        <!--                mm = '0' + mm;-->
        <!--            }-->

        <!--            if (dd < 10) {-->
        <!--                dd = '0' + dd;-->
        <!--            }-->

        <!--            var minDate = yyyy + '-' + mm + '-' + dd;-->

        <!--            // 최소 날짜를 설정-->
        <!--            document.getElementById("startDateInput").setAttribute("min", minDate);-->
        <!--        </script>-->
    </div>
</main>

</body>
</html>